<!doctype html><html lang=en dir=ltr><head><meta name=generator content="Hugo 0.80.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Week 9 #  Processes and Redirection #  Launching a New Process #   Clone the process pid_t fork(void); // child gets return value 0, parent gets child's pid  Both processes (child and parent) run the same code   The child can switch to running another program execlp(path, arg0, arg1, ..., (char *)NULL); // 'exec' family of system calls  Things such as environment variables, pid, fd, current dir, etc."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Week 9"><meta property="og:description" content="Week 9 #  Processes and Redirection #  Launching a New Process #   Clone the process pid_t fork(void); // child gets return value 0, parent gets child's pid  Both processes (child and parent) run the same code   The child can switch to running another program execlp(path, arg0, arg1, ..., (char *)NULL); // 'exec' family of system calls  Things such as environment variables, pid, fd, current dir, etc."><meta property="og:type" content="article"><meta property="og:url" content="https://navn-r.github.io/notes/CSCB09/Week-9/"><meta property="article:published_time" content="2020-07-25T20:45:11+00:00"><meta property="article:modified_time" content="2020-07-25T20:45:11+00:00"><title>Week 9 - CSCB09</title><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@420&family=IBM+Plex+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link rel=manifest href=/notes/manifest.json><link rel=icon href=/notes/favicon.png type=image/x-icon><link rel=stylesheet href=/notes/book.min.bb39aba330b9174b16ef802038db41db39c0787e5f90df566a5b5078e49a13c0.css integrity="sha256-uzmrozC5F0sW74AgONtB2znAeH5fkN9WaltQeOSaE8A="><script defer src=/notes/en.search.min.021c96363ec3e0c59115e0b0e5065b07a5e1eb0262052aef5b937b5a06d722f1.js integrity="sha256-AhyWNj7D4MWRFeCw5QZbB6Xh6wJiBSrvW5N7WgbXIvE="></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/notes><span>&lt;✏️ /></span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-41f305c5e3122bf493595a858d4129a1 class=toggle>
<label for=section-41f305c5e3122bf493595a858d4129a1 class="flex justify-between"><a href=https://navn-r.github.io/notes/CSCA48/>CSCA48</a>
<span>▾</span></label><ul><li><a href=https://navn-r.github.io/notes/CSCA48/final-review/>Final Review</a></li></ul></li><li><input type=checkbox id=section-78a08a9976aa3e789bbd624f3262ce34 class=toggle checked>
<label for=section-78a08a9976aa3e789bbd624f3262ce34 class="flex justify-between"><a href=https://navn-r.github.io/notes/CSCB09/>CSCB09</a>
<span>▾</span></label><ul><li><a href=https://navn-r.github.io/notes/CSCB09/Week-1/>Week 1</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-2/>Week 2</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-3/>Week 3</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-4/>Week 4</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-5/>Week 5</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-6/>Week 6</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-7/>Week 7</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-8/>Week 8</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-9/ class=active>Week 9</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-10/>Week 10</a></li><li><a href=https://navn-r.github.io/notes/CSCB09/Week-11/>Week 11</a></li></ul></li><li><input type=checkbox id=section-f93fc08454e785bc3348bdfad48cbd90 class=toggle>
<label for=section-f93fc08454e785bc3348bdfad48cbd90 class="flex justify-between"><a href=https://navn-r.github.io/notes/CSCC01/>CSCC01</a>
<span>▾</span></label><ul><li><a href=https://navn-r.github.io/notes/CSCC01/final-review/>Final Review</a></li></ul></li><li><input type=checkbox id=section-717d341229bce3459525c2c9d3ec32a6 class=toggle>
<label for=section-717d341229bce3459525c2c9d3ec32a6 class="flex justify-between"><a href=https://navn-r.github.io/notes/CSCC24/>CSCC24</a>
<span>▾</span></label><ul><li><a href=https://navn-r.github.io/notes/CSCC24/Week-1/>Week 1</a></li><li><a href=https://navn-r.github.io/notes/CSCC24/Week-2/>Week 2</a></li></ul></li></ul><ul><li><a href=https://github.com/navn-r/notes target=_blank rel=noopener>Github Repo</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/notes/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Week 9</strong>
<label for=toc-control><img src=/notes/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#processes-and-redirection>Processes and Redirection</a><ul><li><a href=#launching-a-new-process>Launching a New Process</a></li><li><a href=#the-only-parent-less-process-init>The only &lsquo;parent-less&rsquo; process: <code>init</code></a></li><li><a href=#process-commands>Process Commands</a></li><li><a href=#waiting-for-a-child-process>Waiting for a Child process</a></li><li><a href=#termination-of-parent-before-child>Termination of Parent before Child</a></li><li><a href=#file-redirection>File Redirection</a></li><li><a href=#pipes>Pipes</a></li></ul></li><li><a href=#signals>Signals</a><ul><li></li><li><a href=#signal-life-cycle>Signal Life Cycle</a></li><li><a href=#signal-actionshandlers>Signal Actions/Handlers</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=week-9>Week 9
<a class=anchor href=#week-9>#</a></h1><h2 id=processes-and-redirection>Processes and Redirection
<a class=anchor href=#processes-and-redirection>#</a></h2><h3 id=launching-a-new-process>Launching a New Process
<a class=anchor href=#launching-a-new-process>#</a></h3><ol><li>Clone the process<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>pid_t <span style=color:#a6e22e>fork</span>(<span style=color:#66d9ef>void</span>); <span style=color:#75715e>// child gets return value 0, parent gets child&#39;s pid 
</span></code></pre></div><ul><li>Both processes (child and parent) run the same code</li></ul></li><li>The child can switch to running another program<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>execlp(path, arg0, arg1, ..., (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)NULL); <span style=color:#75715e>// &#39;exec&#39; family of system calls
</span></code></pre></div><ul><li>Things such as environment variables, pid, fd, current dir, etc. are preserved</li><li>File descriptors can be closed before exec by marking them as <code>close on exec</code></li></ul></li></ol><h4 id=why-seperate-fork-and-exec>Why seperate <code>fork</code> and <code>exec</code>?
<a class=anchor href=#why-seperate-fork-and-exec>#</a></h4><ul><li>Some use cases do not require <code>exec</code></li><li>The child process can do some prep before <code>exec</code> (file redirection and pipelining)</li></ul><h3 id=the-only-parent-less-process-init>The only &lsquo;parent-less&rsquo; process: <code>init</code>
<a class=anchor href=#the-only-parent-less-process-init>#</a></h3><ul><li><code>fork</code> is the only way to launch new processes</li><li>As the kernel boots, it launches <code>init</code>, with pid 1</li></ul><h3 id=process-commands>Process Commands
<a class=anchor href=#process-commands>#</a></h3><ul><li><code>ps</code>: List processes</li><li><code>pgrep</code>: Find processes by name, users, etc.</li><li><code>top</code>: Process list that periodically refreshes (think of it as a terminal task manager)</li><li><code>htop</code>: <code>top</code>, but better (more features)</li><li><code>kill</code> and <code>pkill</code>: Terminates a process if allowed (<code>pkill</code> finds like <code>pgrep</code>)</li></ul><h3 id=waiting-for-a-child-process>Waiting for a Child process
<a class=anchor href=#waiting-for-a-child-process>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>pid_t <span style=color:#a6e22e>wait</span>(<span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>status); <span style=color:#75715e>// status is for child&#39;s exit code
</span><span style=color:#75715e></span>pid_t <span style=color:#a6e22e>waitpid</span>(pid_t pid, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>status, <span style=color:#66d9ef>int</span> options);
<span style=color:#75715e>// pid &gt; 0 -&gt; wait for the given child
</span><span style=color:#75715e>// pid == -1 -&gt; wait for any child
</span><span style=color:#75715e>// options == WNOHANG -&gt; don&#39;t hang waiting
</span></code></pre></div><h4 id=useful-macros>Useful macros
<a class=anchor href=#useful-macros>#</a></h4><ul><li>Normal Termination:<ul><li><code>WIFEXITED</code>, <code>WEXITSTATUS</code></li></ul></li><li>Killed by signal:<ul><li><code>WIFSIGNALED</code>, <code>WTERMSIG</code>, <code>WCOREDUMP</code></li></ul></li><li>Stopped and continued by signal:<ul><li><code>WIFSTOPPED</code>, <code>WIFCONTINUED</code></li></ul></li></ul><h3 id=termination-of-parent-before-child>Termination of Parent before Child
<a class=anchor href=#termination-of-parent-before-child>#</a></h3><ul><li>If the child terminates first and the parent process is still running and does not call <code>wait</code><ul><li>A &lsquo;zombie&rsquo; process of the child retains the entry of the child, but is not actually running</li></ul></li><li>If the parent terminates but the child is still running<ul><li>The child is now an &lsquo;orphan&rsquo; process and gets the parent pid of <code>init</code></li></ul></li><li>If the child terminates and the parent calls <code>wait</code><ul><li>Just regular termination and no &lsquo;zombie&rsquo;</li></ul></li></ul><h3 id=file-redirection>File Redirection
<a class=anchor href=#file-redirection>#</a></h3><ul><li>Before <code>exec</code> and <code>fork</code>, open the file</li><li>Duplicate the file descriptor with <code>dup2(curr_fd, new_fd)</code></li><li>Close the file descriptor or request <code>close on exec</code></li><li>Then call <code>exec</code></li></ul><h3 id=pipes>Pipes
<a class=anchor href=#pipes>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>pipe</span>(<span style=color:#66d9ef>int</span> pipefd[<span style=color:#ae81ff>2</span>]); <span style=color:#75715e>// creates a unidirectional pipe
</span><span style=color:#75715e>// pipefd[0] is for read end
</span><span style=color:#75715e>// pipefd[1] is for write end
</span></code></pre></div><ul><li>This is how shells do pipelining</li><li>Usually, only one process at both ends</li><li>For <code>dup/dup2</code>, <code>stdout</code> for write end, and <code>stdin</code> for read end.</li><li>Close fds you do not need as soon as possible</li><li>Kernel has a buffer for unread data if the <code>write end</code> is writing faster than the <code>read end</code> can handle</li></ul><h2 id=signals>Signals
<a class=anchor href=#signals>#</a></h2><blockquote><p>How the kernel notifies processes of some events and severe errors</p></blockquote><h4 id=examples>Examples
<a class=anchor href=#examples>#</a></h4><ul><li><p>Interupt (<code>CTRL+C</code>): <code>SIGINT</code></p></li><li><p>Suspend and Resume: <code>SIGSTOP</code>,<code>SIGCONT</code></p></li><li><p>Child died/suspended/resumed:<code>SIGCHLD</code></p></li><li><p>Broken pipe:<code>SIGPIPE</code></p></li><li><p>Request for termination (shell ‘<code>kill</code>’ default):<code>SIGTERM</code></p></li><li><p>Hard request for termination:<code>SIGKILL</code></p></li><li><p>Illegal memory access (two types:<code>SIGBUS</code>,<code>SIGSEGV</code>)</p></li><li><p>Application-specific:<code>SIGUSR1</code>,<code>SIGUSR2</code></p></li></ul><h3 id=signal-life-cycle>Signal Life Cycle
<a class=anchor href=#signal-life-cycle>#</a></h3><ul><li>Some events generate a signal</li><li>Kernel tries to deliver the signal, and is pending until delivered</li><li>Normal exec resumes if signal ignored or handler returns normally</li><li>Shell Command:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kill -SIGKILL <span style=color:#ae81ff>31337</span>
$ kill -9 <span style=color:#ae81ff>31337</span>
</code></pre></div></li><li>System Calls:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>kill</span>(pid_t pid, <span style=color:#66d9ef>int</span> sig);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>raise</span>(<span style=color:#66d9ef>int</span> sig); <span style=color:#75715e>// to self
</span></code></pre></div></li></ul><h3 id=signal-actionshandlers>Signal Actions/Handlers
<a class=anchor href=#signal-actionshandlers>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>int</span> sigaction(<span style=color:#66d9ef>int</span> sig, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> sigaction <span style=color:#f92672>*</span>act, <span style=color:#66d9ef>struct</span> sigaction <span style=color:#f92672>*</span>oldact)
</code></pre></div><ul><li><code>sig</code>: The signal type</li><li><code>act</code>: The new action you want</li><li><code>oldact</code>: The old action</li><li>on <code>fork</code>: Signal actions cloned</li><li>on <code>exec</code>: Handlers are replaced by default</li></ul><h4 id=struct-sigaction><code>struct sigaction</code>
<a class=anchor href=#struct-sigaction>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>struct</span> sigaction {
  <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>sa_handler(<span style=color:#66d9ef>int</span> sig);  <span style=color:#75715e>// pointer to handler function, SIG_IN, or SIG_DFL
</span><span style=color:#75715e></span>  sigset_t sa_mask;           <span style=color:#75715e>// mask these signals when running handler
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> sa_flags;               <span style=color:#75715e>// options
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sa_restorer</span>(<span style=color:#66d9ef>void</span>);    <span style=color:#75715e>// not for application use
</span><span style=color:#75715e></span>}
</code></pre></div><h4 id=sigset_t-operations><code>sigset_t</code> Operations
<a class=anchor href=#sigset_t-operations>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sigemptyset</span>(sigset_t <span style=color:#f92672>*</span>set);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sigfillset</span>(sigset_t <span style=color:#f92672>*</span>set);  <span style=color:#75715e>// add all signals
</span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sigaddset</span>(sigset_t <span style=color:#f92672>*</span>set, <span style=color:#66d9ef>int</span> sig);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sigdelset</span>(sigset_t <span style=color:#f92672>*</span>set, <span style=color:#66d9ef>int</span> sig);
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>sigismember</span>(<span style=color:#66d9ef>const</span> sigset_t <span style=color:#f92672>*</span>set, <span style=color:#66d9ef>int</span> sig);
</code></pre></div><h4 id=sa_flags-flags><code>sa_flags</code> Flags
<a class=anchor href=#sa_flags-flags>#</a></h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=color:#75715e>// If you install handler
</span><span style=color:#75715e></span>SA_NODEFER    <span style=color:#75715e>// don&#39;t mask signal when running handler
</span><span style=color:#75715e></span>SA_RESETHAND  <span style=color:#75715e>// reset action to default before running handler
</span><span style=color:#75715e></span>SA_RESTART    <span style=color:#75715e>// auto-restart most syscalls before running handler
</span><span style=color:#75715e></span>
<span style=color:#75715e>// For SIGCHLD
</span><span style=color:#75715e></span>SA_NOCLDSTOP  <span style=color:#75715e>// don&#39;t signal for child stop/cont.
</span><span style=color:#75715e></span>SA_NOCLDWAIT  <span style=color:#75715e>// don&#39;t turn terminated child into zombie
</span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#processes-and-redirection>Processes and Redirection</a><ul><li><a href=#launching-a-new-process>Launching a New Process</a></li><li><a href=#the-only-parent-less-process-init>The only &lsquo;parent-less&rsquo; process: <code>init</code></a></li><li><a href=#process-commands>Process Commands</a></li><li><a href=#waiting-for-a-child-process>Waiting for a Child process</a></li><li><a href=#termination-of-parent-before-child>Termination of Parent before Child</a></li><li><a href=#file-redirection>File Redirection</a></li><li><a href=#pipes>Pipes</a></li></ul></li><li><a href=#signals>Signals</a><ul><li></li><li><a href=#signal-life-cycle>Signal Life Cycle</a></li><li><a href=#signal-actionshandlers>Signal Actions/Handlers</a></li></ul></li></ul></nav></div></aside></main><link rel=stylesheet href=/notes/katex/katex.min.css><script defer src=/notes/katex/katex.min.js></script><script defer src=/notes/katex/auto-render.min.js onload="renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false},],});"></script></body></html>